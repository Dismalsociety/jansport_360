import pandas as pd
import numpy as np
import matplotlib.pyplot as plt


# SECTION 1: Load the data
print("Loading data...")
df = pd.read_excel('generated_training_data.xlsx')
times = df['Time (s)'].values
flows = df['Flow Rate (gpm)'].values
pressures = df['Predicted Pressure (psiA)'].values


# SECTION 2: Find the peak threshold
mean_flow = np.mean(flows)
std_flow = np.std(flows)
peak_threshold = mean_flow + 0.5 * std_flow
print(f"Peak threshold: {peak_threshold:.2f} gpm")


# SECTION 3: Find all peaks
peak_regions = []
in_peak = False
peak_start = 0

for i in range(len(flows)):
    if flows[i] > peak_threshold and not in_peak:
        peak_start = i
        in_peak = True
    elif flows[i] <= peak_threshold and in_peak:
        peak_regions.append((peak_start, i-1))
        in_peak = False

print(f"Found {len(peak_regions)} peaks")


# SECTION 4: Make all peaks reach 103 gpm
PEAK_HEIGHT = 103
modified_flows = flows.copy()

for start, end in peak_regions:
    # Get the peak
    peak_values = flows[start:end+1]
    peak_max = np.max(peak_values)
    
    # Scale it to reach 103
    scale_factor = PEAK_HEIGHT / peak_max
    
    # Apply scaling
    for i in range(start, end+1):
        modified_flows[i] = flows[i] * scale_factor


# SECTION 5: Stretch peaks to be 5x longer
STRETCH_FACTOR = 5
new_times = []
new_flows = []
new_pressures = []

current_time = 0
for i in range(len(times)):
    # Add this point
    new_times.append(current_time)
    new_flows.append(modified_flows[i])
    new_pressures.append(pressures[i])
    
    # Calculate time to next point
    if i < len(times) - 1:
        time_step = times[i+1] - times[i]
        
        # Check if we're in a peak
        in_peak = False
        for start, end in peak_regions:
            if start <= i <= end:
                in_peak = True
                break
        
        # Stretch if in peak
        if in_peak:
            time_step = time_step * STRETCH_FACTOR
            
        current_time = current_time + time_step


# SECTION 6: Save the new data
new_df = pd.DataFrame({
    'Time (s)': new_times,
    'Flow Rate (gpm)': new_flows
})

new_df.to_excel('stretched_training_data.xlsx', index=False)
print("Saved to stretched_training_data.xlsx")

